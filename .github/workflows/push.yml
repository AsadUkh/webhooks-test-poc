name: Upload Changed Files to Cloudinary

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  upload_files_to_cloudinary:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code with full history
      uses: actions/checkout@v2
      with:
        fetch-depth: 0  # Fetch full commit history for accurate diff

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install dependencies
      run: |
        npm install axios

    - name: Upload changed files to Cloudinary
      run: |
        # Get list of files that were modified in the commit
        FILES_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})

        # Debugging: List files
        echo "Changed files: $FILES_CHANGED"

        # Iterate over the changed files and upload them to Cloudinary
        for FILE in $FILES_CHANGED; do
          if [[ -f "$FILE" ]]; then
            echo "Uploading $FILE to Cloudinary..."

            # Use Cloudinary API to upload the file
            curl -X POST "https://api.cloudinary.com/v1_1/${{ secrets.CLOUDINARY_CLOUD_NAME }}/raw/upload" \
              -F "file=@$FILE" \
              -F "upload_preset=ml_default" \
              -F "public_id=$FILE" \
              -u "${{ secrets.CLOUDINARY_API_KEY }}:${{ secrets.CLOUDINARY_API_SECRET }}"
          else
            echo "No file found for: $FILE"
          fi
        done
