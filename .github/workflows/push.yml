name: Upload Files to Cloudinary on Push/Merge

on:
  push:
    branches:
      - main  
  pull_request:
    branches:
      - main 

jobs:
  upload_files_to_cloudinary:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'  # You can use the version you need

    - name: Install dependencies
      run: |
        npm install axios  # Axios to handle HTTP requests

    # Upload changed files to Cloudinary
    - name: Upload changed files to Cloudinary
      run: |
        # Get list of files that were modified in the commit
        FILES_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})

        # Iterate over the changed files and upload them to Cloudinary
        for FILE in $FILES_CHANGED; do
          if [[ -f "$FILE" ]]; then
            echo "Uploading $FILE to Cloudinary..."

            # Use Cloudinary API to upload the file
            curl -X POST "https://api.cloudinary.com/v1_1/${{ secrets.CLOUDINARY_CLOUD_NAME }}/raw/upload" \
              -F "file=@$FILE" \
              -F "upload_preset=ml_default" \
              -F “public_id=@$FILE” \
              -u "${{ secrets.CLOUDINARY_API_KEY }}:${{ secrets.CLOUDINARY_API_SECRET }}"
          fi
        done
